{% extends "base.html" %}
{% load static %}

{% block content %}


<main class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Закажете нов термин</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Hospital Selection -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Одберете Клиника</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="hospitalTable">
                                            <thead>
                                                <tr>
                                                    <th>Име на Клиника</th>
                                                    <th>Град</th>
                                                    <th>Избери</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Hospitals will be loaded dynamically -->
                                                <tr>
                                                    <td colspan="3" class="text-center">
                                                        <div class="spinner-border text-primary" id="loadingSpinner" role="status"></div>
                                                            <span class="visually-hidden">Вчитување...</span>
                                                            Вчитување...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Service and Doctor Selection (Initially hidden) -->
                        <div class="col-md-6">
                            <div id="selectionOptions" style="display: none;">
                                <!-- Service Selection -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Одделение</h5>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select" id="departmentSelect" disabled>
                                            <option value="">Одберете одделение...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Doctor Selection -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Доктор</h5>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select" id="doctorSelect" disabled>
                                            <option value="">Одберете доктор...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Selected Info -->
                                <div class="card mt-3" id="selectedInfoCard" style="display: none;">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Избрани информации</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Клиника:</strong> <span id="selectedHospital"></span></p>
                                        <p><strong>Одделение:</strong> <span id="selectedDepartment"></span></p>
                                        <p><strong>Доктор:</strong> <span id="selectedDoctor"></span></p>
                                        <button class="btn btn-primary w-100" id="continueBtn" disabled>Продолжете со закажувањето</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Add this section right after the existing selected info card -->


<style>
    .card {
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .table-hover tbody tr.selected {
        background-color: #007bff;
        color: white;
    }
    .btn-primary {
        background-color: #007bff;
        border: none;
        padding: 10px;
        font-weight: 500;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>document.addEventListener("DOMContentLoaded", function() {
    const hospitalTable = document.getElementById('hospitalTable');
    const selectionOptions = document.getElementById('selectionOptions');
    const departmentSelect = document.getElementById('departmentSelect');
    const doctorSelect = document.getElementById('doctorSelect');
    const selectedInfoCard = document.getElementById('selectedInfoCard');
    const continueBtn = document.getElementById('continueBtn');
    const selectedHospital = document.getElementById('selectedHospital');
    const selectedDepartment = document.getElementById('selectedDepartment');
    const selectedDoctor = document.getElementById('selectedDoctor');


    let selectedHospitalId = null;
    let selectedDepartmentId = null;
    let allDoctors = []; // Store all doctors for the hospital
    let filteredDoctors = []; // Store filtered doctors by department

    // Function to clear all selections
    function clearAllSelections() {
        // Reset dropdowns to default state
        departmentSelect.innerHTML = '<option value="">Одберете одделение...</option>';
        doctorSelect.innerHTML = '<option value="">Одберете доктор...</option>';
        
        // Clear displayed values
        selectedDepartment.textContent = '';
        selectedDoctor.textContent = '';
        
        // Disable dropdowns until new data loads
        departmentSelect.disabled = true;
        doctorSelect.disabled = true;
        
        // Disable continue button
        continueBtn.disabled = true;
        
        // Clear stored data
        allDoctors = [];
        filteredDoctors = [];
        selectedDepartmentId = null;
    }

    // Load hospitals
    axios.get('/api/hospitals/hospitals/')
        .then(response => {
            const hospitals = response.data;
            const tbody = hospitalTable.querySelector('tbody');
            tbody.innerHTML = '';

            hospitals.forEach(hospital => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${hospital.name}</td>
                    <td>${hospital.town || 'Неодреден'}, ${hospital.address || ''}</td>
                    <td>
                        <input type="radio" name="hospital" value="${hospital.id}">
                    </td>
                `;
                row.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('#hospitalTable tbody tr').forEach(r => {
                        r.classList.remove('selected');
                        r.querySelector('input[type="radio"]').checked = false;
                    });
                    
                    // Select this row
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    
                    // Clear all previous selections before loading new hospital data
                    clearAllSelections();
                    
                    selectedHospitalId = hospital.id;
                    selectedHospital.textContent = hospital.name;
                    
                    // Show selection options
                    selectionOptions.style.display = 'block';
                    
                    // Load departments and doctors for this hospital
                    loadDepartments(hospital.id);
                    loadAllDoctors(hospital.id);
                    
                    // Show selected info
                    selectedInfoCard.style.display = 'block';
                });
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading hospitals:', error);
            hospitalTable.querySelector('tbody').innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-danger">
                        Грешка при вчитување на клиниките. Обидете се повторно.
                    </td>
                </tr>
            `;
        });

    // Load departments for selected hospital
    function loadDepartments(hospitalId) {
        departmentSelect.innerHTML = '<option value="">Вчитување на одделенија...</option>';
        departmentSelect.disabled = true;

        axios.get(`/api/hospitals/hospitals/${hospitalId}/departments/`)
            .then(response => {
                const departments = response.data;
                departmentSelect.innerHTML = '<option value="">Одберете одделение...</option>';
                
                departments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.id;
                    option.textContent = department.name;
                    departmentSelect.appendChild(option);
                });
                if (departments.length === 0 ){
                    departmentSelect.innerHTML = '<option value="">Нема одделенија во оваа клиника</option>';
                }
                departmentSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading departments:', error);
                departmentSelect.innerHTML = '<option value="">Грешка при вчитување</option>';
            });
    }

    // Load ALL doctors for the selected hospital
    function loadAllDoctors(hospitalId) {
        doctorSelect.innerHTML = '<option value="">Вчитување на доктори...</option>';
        doctorSelect.disabled = true;
        const userId = {{ user.id }};
        // Use your existing hospital doctors endpoint
        axios.get(`/api/hospitals/hospitals/${hospitalId}/doctors/${userId}/`)
            .then(response => {
                allDoctors = response.data;
                populateDoctorDropdown(allDoctors);
                doctorSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading doctors:', error);
                doctorSelect.innerHTML = '<option value="">Грешка при вчитување</option>';
            });
    }

    // Populate doctor dropdown with doctors
    function populateDoctorDropdown(doctors) {
        doctorSelect.innerHTML = '<option value="">Одберете доктор...</option>';
        
        if (doctors.length === 0) {
            doctorSelect.innerHTML = '<option value="">Нема доктори во оваа клиника</option>';
            return;
        }
        
        doctors.forEach(doctor => {
            const option = document.createElement('option');
            option.value = doctor.id;
            option.textContent = `Д-р ${doctor.first_name} ${doctor.last_name}`;
            option.dataset.department = doctor.department_id || ''; 
            doctorSelect.appendChild(option);
        });
    }

    // Filter doctors based on selected department
    function filterDoctorsByDepartment(departmentId) {
        if (!departmentId) {
            // Show all doctors if no department selected
            populateDoctorDropdown(allDoctors);
            return;
        }

        // Filter doctors by department
        filteredDoctors = allDoctors.filter(doctor => 
            doctor.department_id == departmentId || 
            (doctor.departments && doctor.departments.includes(parseInt(departmentId)))
        );
        
        populateDoctorDropdown(filteredDoctors);
    }

    // Department selection handler
    departmentSelect.addEventListener('change', function() {
        const departmentId = this.value;
        selectedDepartmentId = departmentId;
        
        if (departmentId) {
            selectedDepartment.textContent = this.options[this.selectedIndex].text;
            // Filter doctors by selected department
            filterDoctorsByDepartment(departmentId);
        } else {
            selectedDepartment.textContent = '';
            // Show all doctors when no department is selected
            populateDoctorDropdown(allDoctors);
        }
        
        checkContinueButton();
    });

    // Doctor selection handler
    doctorSelect.addEventListener('change', function() {
        if (this.value) {
            selectedDoctor.textContent = this.options[this.selectedIndex].text;
            
            // Auto-select the department if a doctor is selected
            const selectedDoctorOption = this.options[this.selectedIndex];
            const doctorDepartmentId = selectedDoctorOption.dataset.department;
            
            if (doctorDepartmentId && departmentSelect.value !== doctorDepartmentId) {
                departmentSelect.value = doctorDepartmentId;
                selectedDepartment.textContent = departmentSelect.options[departmentSelect.selectedIndex].text;
                selectedDepartmentId = doctorDepartmentId;
            }
        } else {
            selectedDoctor.textContent = '';
        }
        
        checkContinueButton();
    });
    // Check if continue button should be enabled
    function checkContinueButton() {
        continueBtn.disabled = !(doctorSelect.value);
    }

    // Continue button handler
    continueBtn.addEventListener('click', function() {
        const doctorId = doctorSelect.value;
        const departmentId = departmentSelect.value;
        window.location.href = `/api/hospitals/service/?doctor_id=${doctorId}&department_id=${departmentId}`;
    });
});
</script>

{% endblock %}

