{% extends "base.html" %}
{% load static %}

{% block content %}

<main>
    <div class="container-xl px-4 mt-4">
        <!-- Account page navigation-->
        <nav class="nav nav-borders">
            <a class="nav-link active " href="#" id="profile-tab">Профил</a>
            <a class="nav-link ms-0" href="#" id="security-tab">Безбедност</a>
            {% if request.user.is_staff %}
            <a class="nav-link ms-0" href="#" id="services-tab">Додај Услуги</a>
            {% endif %}
        </nav>
        <hr class="mt-0 mb-4">
         <div id="profile-section">
            <div class="row">
                <div class="col-xl-4">
                    <!-- Profile picture card-->
                    <div class="card mb-4 mb-xl-0">
                        <div class="card-body text-center">
                            <!-- Profile picture image-->
                            <img class="img-account-profile rounded-circle mb-2" src="{% static 'images/profile.png' %}" alt="">
                            <!-- Profile picture help block-->
                            <div class="small font-italic text-muted mb-4">{{ user.first_name }} {{ user.last_name }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-8">
                    <!-- Account details card-->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Детали на Профил</span>
                            <button id="edit-toggle-btn" class="btn btn-outline-primary btn-sm">Уреди профил</button>
                        </div>
                        <div class="card-body">
                            <form id="profile-form" method="POST" action="{% url 'update_profile' %}">
                                {% csrf_token %}
                                <!-- Form Row-->
                                <div class="row gx-3 mb-3">
                                    <!-- Form Group (first name)-->
                                    <div class="col-md-6">
                                        <label class="small mb-1" for="inputFirstName">Име</label>
                                        <input class="form-control" id="inputFirstName" name="first_name" type="text" 
                                               value="{{ user.first_name }}" disabled>
                                    </div>
                                    <!-- Form Group (last name)-->
                                    <div class="col-md-6">
                                        <label class="small mb-1" for="inputLastName">Презиме</label>
                                        <input class="form-control" id="inputLastName" name="last_name" type="text" 
                                               value="{{ user.last_name }}" disabled>
                                    </div>
                                </div>            
                                <!-- Form Group (email address)-->
                                <div class="mb-3">
                                    <label class="small mb-1" for="inputEmailAddress">Email</label>
                                    <input class="form-control" id="inputEmailAddress" name="email" type="email" 
                                           value="{{ user.email }}" disabled>
                                </div>
                                <!-- Save changes button (hidden by default)-->
                                <button id="save-changes-btn" class="btn btn-primary d-none" type="submit">Зачувај ги промените</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="security-section">
            <div class="row">
                <div class="col-xl-8">
                    <!-- Security details card-->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Безбедносни лични податоци</span>
                            <button id="edit-security-btn" class="btn btn-outline-primary btn-sm">Уреди безбедносни податоци</button>
                        </div>
                        <div class="card-body">
                            <form id="security-form" method="POST" action="{% url 'update_security' %}">
                                {% csrf_token %}
                                <!-- Form Group (phone number)-->
                                <div class="mb-3">
                                    <label class="small mb-1" for="inputPhoneNumber">Телефонски број</label>
                                    <input class="form-control" id="inputPhoneNumber" name="phone_number" type="tel" 
                                           value="{{ user.phone_number|default:'' }}" disabled>
                                    <div class="form-text">Вашиот телефонски број ќе се користи за верификација и контакт.</div>
                                </div>
                                
                                <!-- Form Group (password)-->
                                <div class="mb-3">
                                    <label class="small mb-1" for="inputPassword">Лозинка</label>
                                    <input class="form-control" id="inputPassword" name="password" type="password" 
                                           placeholder="Внесете нова лозинка" disabled>
                                    <div class="form-text">Оставете празно ако не сакате да ја промените лозинката.</div>
                                </div>
                                <!-- Form Group (confirm password)-->
                                <div class="mb-3">
                                    <label class="small mb-1" for="inputConfirmPassword">Потврди нова лозинка</label>
                                    <input class="form-control" id="inputConfirmPassword" name="confirm_password" type="password" 
                                        placeholder="Потврдете ја новата лозинка" disabled>
                                    <div class="form-text">Мора да ја потврдите новата лозинка.</div>
                                </div>
                                <!-- Form Group (share information)-->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="shareInformation" name="share_info" type="checkbox" 
                                               {% if user.share_info %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="shareInformation">
                                            Сподели информации
                                        </label>
                                        <div class="form-text">Овозможете споделување на информации од вашите претходно извршени прегледи на докторите со цел подобро спроведување на прегледот/услугата.</div>
                                    </div>
                                </div>
                                
                                <!-- Save changes button (hidden by default)-->
                                <button id="save-security-btn" class="btn btn-primary d-none" type="submit">Зачувај промени</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if request.user.is_staff %}
        <div id="services-section" style="display: none;">
            <div class="row">
                <div class="col-xl-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <span>Додај Услуги</span>
                        </div>
                        <div class="card-body">
                            <form id="services-form" method="POST" action="{% url 'add-services' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="small mb-1" for="serviceSelect">Избери услуги од вашиот оддел</label>
                                    <select class="form-control" id="serviceSelect" name="services" multiple size="5">
                                        {% for service in available_services %}
                                        <option value="{{ service.id }}">{{ service.name }}</option>
                                        {% empty %}
                                        <option disabled>Нема достапни услуги за вашиот оддел</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Држете Ctrl копчето за да изберете повеќе услуги.</div>
                                </div>
                                <button class="btn btn-primary" type="submit">Додај избрани услуги</button>
                            </form>
                            
                            <!-- List of already requested services -->
                            <div class="mt-4">
                                <h5>Веќе додадени услуги</h5>
                                <ul class="list-group">
                                    {% for assignment in my_service_assignments %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ assignment.service.name }}
                                        <span class="badge {% if assignment.approved %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                                            {% if assignment.approved %}Одобрена{% else %}Чека одобрување{% endif %}
                                        </span>
                                    </li>
                                    {% empty %}
                                    <li class="list-group-item">Сеуште немате додадено услуги.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</main>

<style type="text/css">
    .img-account-profile {
        height: 10rem;
    }
    .rounded-circle {
        border-radius: 50% !important;
    }
    .card {
        box-shadow: 0 0.15rem 1.75rem 0 rgb(33 40 50 / 15%);
    }
    .card .card-header {
        font-weight: 500;
    }
    .card-header:first-child {
        border-radius: 0.35rem 0.35rem 0 0;
    }
    .card-header {
        padding: 1rem 1.35rem;
        margin-bottom: 0;
        background-color: rgba(33, 40, 50, 0.03);
        border-bottom: 1px solid rgba(33, 40, 50, 0.125);
    }
    .form-control, .dataTable-input {
        display: block;
        width: 100%;
        padding: 0.875rem 1.125rem;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1;
        color: #69707a;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #c5ccd6;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: 0.35rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-control:disabled {
        background-color: #f8f9fa;
        opacity: 1;
    }
    .nav-borders .nav-link.active {
        color: #0061f2;
        border-bottom-color: #0061f2;
    }
    .nav-borders .nav-link {
        color: #69707a;
        border-bottom-width: 0.125rem;
        border-bottom-style: solid;
        border-bottom-color: transparent;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        padding-left: 0;
        padding-right: 0;
        margin-left: 1rem;
        margin-right: 1rem;
    }
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding-bottom: 70px;
    }
    .main-content {
        flex: 1;
    }
    
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editToggleBtn = document.getElementById('edit-toggle-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const profileForm = document.getElementById('profile-form');
    const inputs = profileForm.querySelectorAll('input');
    let isEditing = false;
    
    // Tab management
    const profileTab = document.getElementById('profile-tab');
    const securityTab = document.getElementById('security-tab');
    const profileSection = document.getElementById('profile-section');
    const securitySection = document.getElementById('security-section');
    
    // Add services tab if it exists (for doctors)
    const servicesTab = document.getElementById('services-tab');
    const servicesSection = document.getElementById('services-section');
    
    // Initially show only profile section
    profileSection.style.display = 'block';
    securitySection.style.display = 'none';
    if (servicesSection) servicesSection.style.display = 'none';
    
    profileTab.classList.add('active');
    securityTab.classList.remove('active');
    if (servicesTab) servicesTab.classList.remove('active');

    // Profile tab click
    profileTab.addEventListener('click', function(e) {
        e.preventDefault();
        profileSection.style.display = 'block';
        securitySection.style.display = 'none';
        if (servicesSection) servicesSection.style.display = 'none';
        
        profileTab.classList.add('active');
        securityTab.classList.remove('active');
        if (servicesTab) servicesTab.classList.remove('active');
    });
    
    // Security tab click
    securityTab.addEventListener('click', function(e) {
        e.preventDefault();
        profileSection.style.display = 'none';
        securitySection.style.display = 'block';
        if (servicesSection) servicesSection.style.display = 'none';
        
        profileTab.classList.remove('active');
        securityTab.classList.add('active');
        if (servicesTab) servicesTab.classList.remove('active');
    });
    
    // Services tab click (if exists) - FIXED: Properly closed this block
    if (servicesTab) {
        servicesTab.addEventListener('click', function(e) {
            e.preventDefault();
            profileSection.style.display = 'none';
            securitySection.style.display = 'none';
            servicesSection.style.display = 'block';
            
            profileTab.classList.remove('active');
            securityTab.classList.remove('active');
            servicesTab.classList.add('active');
        });
    } // This closing brace was missing

    // Toggle edit mode
    editToggleBtn.addEventListener('click', function() {
        isEditing = !isEditing;
        
        if (isEditing) {
            // Enable editing
            inputs.forEach(input => input.disabled = false);
            editToggleBtn.textContent = 'Откажи';
            editToggleBtn.classList.remove('btn-outline-primary');
            editToggleBtn.classList.add('btn-outline-secondary');
            saveChangesBtn.classList.remove('d-none');
        } else {
            // Disable editing and reset values
            inputs.forEach(input => {
                input.disabled = true;
                // Reset to original values
                if (input.name === 'first_name') input.value = '{{ user.first_name }}';
                if (input.name === 'last_name') input.value = '{{ user.last_name }}';
                if (input.name === 'email') input.value = '{{ user.email }}';
            });
            editToggleBtn.textContent = 'Уреди профил';
            editToggleBtn.classList.remove('btn-outline-secondary');
            editToggleBtn.classList.add('btn-outline-primary');
            saveChangesBtn.classList.add('d-none');
        }
    });

    // Handle form submission
    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Basic validation
        const firstName = document.getElementById('inputFirstName').value.trim();
        const lastName = document.getElementById('inputLastName').value.trim();
        const email = document.getElementById('inputEmailAddress').value.trim();
        
        if (!firstName || !lastName || !email) {
            alert('Сите полиња се задолжителни!');
            return;
        }
        
        if (!isValidEmail(email)) {
            alert('Внесете валидна email адреса!');
            return;
        }
        
        // Submit form via AJAX
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Податоците се успешно зачувани!');
                // Exit edit mode
                isEditing = false;
                inputs.forEach(input => input.disabled = true);
                editToggleBtn.textContent = 'Уреди профил';
                editToggleBtn.classList.remove('btn-outline-secondary');
                editToggleBtn.classList.add('btn-outline-primary');
                saveChangesBtn.classList.add('d-none');
                
                // Update the displayed name under the profile picture
                document.querySelector('.small.font-italic.text-muted.mb-4').textContent = 
                    `${firstName} ${lastName}`;
            } else {
                alert('Грешка при зачувување: ' + (data.message || 'Обидете се повторно.'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Настана грешка. Обидете се повторно.');
        });
    });
    
    // Email validation function
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }
    
    const editSecurityBtn = document.getElementById('edit-security-btn');
    const saveSecurityBtn = document.getElementById('save-security-btn');
    const securityForm = document.getElementById('security-form');
    const securityInputs = securityForm.querySelectorAll('input');
    let isEditingSecurity = false;
    
    editSecurityBtn.addEventListener('click', function() {
        isEditingSecurity = !isEditingSecurity;
        
        if (isEditingSecurity) {
            // Enable editing
            securityInputs.forEach(input => input.disabled = false);
            editSecurityBtn.textContent = 'Откажи';
            editSecurityBtn.classList.remove('btn-outline-primary');
            editSecurityBtn.classList.add('btn-outline-secondary');
            saveSecurityBtn.classList.remove('d-none');
        } else {
            // Disable editing and reset values
            securityInputs.forEach(input => {
                input.disabled = true;
                // Reset to original values
                if (input.name === 'phone_number') input.value = "{{ user.phone_number|default:'' }}";
                if (input.name === 'password') input.value = '';
                if (input.name === 'share_info') input.checked = {% if user.share_info %}true{% else %}false{% endif %};
            });
            editSecurityBtn.textContent = 'Уреди безбедносни податоци';
            editSecurityBtn.classList.remove('btn-outline-secondary');
            editSecurityBtn.classList.add('btn-outline-primary');
            saveSecurityBtn.classList.add('d-none');
        }
    });
    
    // Handle security form submission
    securityForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const phoneNumber = document.getElementById('inputPhoneNumber').value.trim();
        const password = document.getElementById('inputPassword').value;
        const confirmPassword = document.getElementById('inputConfirmPassword').value;
        const shareInformation = document.getElementById('shareInformation').checked;
        const originalPhoneNumber = "{{ user.phone_number|default:'' }}";
        
        // Phone number validation
        if (phoneNumber && !isValidPhoneNumber(phoneNumber)) {
            alert('Внесете валиден телефонски број!');
            return;
        }
        
        // Password validation (if provided)
        if (password && password.length < 8) {
            alert('Лозинката мора да има најмалку 8 карактери!');
            return;
        }
        
        if (password !== confirmPassword) {
            alert('Лозинките не се совпаѓаат!');
            return;
        }
        
        // Submit form via AJAX
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Податоците се успешно зачувани!');
                
                // If phone number was changed, redirect to verification
                if (phoneNumber !== originalPhoneNumber && data.requires_verification) {
                    const encodedPhone = encodeURIComponent(phoneNumber);
                    window.location.href = `/api/accounts/verify/?phone_number=${encodedPhone}`;
                    return;
                }
                
                // Exit edit mode
                isEditingSecurity = false;
                securityInputs.forEach(input => input.disabled = true);
                editSecurityBtn.textContent = 'Уреди безбедносни податоци';
                editSecurityBtn.classList.remove('btn-outline-secondary');
                editSecurityBtn.classList.add('btn-outline-primary');
                saveSecurityBtn.classList.add('d-none');
                
            } else {
                alert('Грешка при зачувување: ' + (data.message || 'Обидете се повторно.'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Настана грешка. Обидете се повторно.');
        });
    });
    
    // Phone number validation function
    function isValidPhoneNumber(phone) {
        const re = /^[+]?[0-9]{9,15}$/;
        return re.test(phone);
    }
    
    // Services form handling
    const servicesForm = document.getElementById('services-form');
    if (servicesForm) {
        servicesForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedServices = Array.from(document.getElementById('serviceSelect').selectedOptions)
                .map(option => option.value);
            
            if (selectedServices.length === 0) {
                alert('Изберете барем една услуга!');
                return;
            }
            
            // Submit form via AJAX
            const formData = new FormData(this);
            formData.append('selected_services', JSON.stringify(selectedServices));
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Услугите се успешно додадени! Чекајте на одобрување.');
                    // Reload the page to show updated list
                    location.reload();
                } else {
                    alert('Грешка при додавање на услуги: ' + (data.message || 'Обидете се повторно.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Настана грешка. Обидете се повторно.');
            });
        });
    }
});
</script>
{% endblock %}